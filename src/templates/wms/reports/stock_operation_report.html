{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h4 class="mb-3">Звіт по операціях зі складом</h4>

  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <input type="date" name="date_from" value="{{ date_from }}" class="form-control" placeholder="Дата від">
    </div>
    <div class="col-md-3">
      <input type="date" name="date_to" value="{{ date_to }}" class="form-control" placeholder="Дата до">
    </div>
    <div class="col-md-3">
      <select name="operation_type" class="form-select">
        <option value="">Всі типи операцій</option>
        {% for val, label in operation_choices %}
          <option value="{{ val }}" {% if operation_type == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <button type="submit" class="btn btn-primary">Фільтрувати</button>
    </div>
    <div class="col-md-2 mt-2">
      <a href="?export=excel&date_from={{ date_from }}&date_to={{ date_to }}&operation_type={{ operation_type }}" class="btn btn-success">Експорт Excel</a>
      <a href="?export=pdf&date_from={{ date_from }}&date_to={{ date_to }}&operation_type={{ operation_type }}" class="btn btn-danger">Експорт PDF</a>
    </div>
  </form>

  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Тип операції</th>
        <th>Користувач</th>
        <th>Причина</th>
        <th>Примітка</th>
        <th>Товари</th>
        <th>Дата</th>
      </tr>
    </thead>
    <tbody>
      {% for op in operations %}
      <tr>
        <td>{{ op.get_operation_type_display }}</td>
        <td>{{ op.created_by.username }}</td>
        <td>{{ op.reason }}</td>
        <td>{{ op.note }}</td>
        <td>
          {% for item in op.items.all %}
            {{ item.product.name }} ({{ item.quantity }}){% if not forloop.last %}, {% endif %}
          {% empty %}
            -
          {% endfor %}
        </td>
        <td>{{ op.created_at|date:"Y-m-d H:i" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="text-center">Операцій не знайдено</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if is_paginated %}
  <nav>
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}&operation_type={{ operation_type }}">«</a>
        </li>
      {% endif %}
      {% for num in paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}&date_from={{ date_from }}&date_to={{ date_to }}&operation_type={{ operation_type }}">{{ num }}</a>
        </li>
      {% endfor %}
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}&operation_type={{ operation_type }}">»</a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}
